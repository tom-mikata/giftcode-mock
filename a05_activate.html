<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ギフトコード管理｜式場別 有効化</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
      --p:#2563eb;--p2:#1d4ed8;--shadow:0 10px 25px rgba(17,24,39,.08);--r:16px;
      --font:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",Arial,sans-serif;
    }
    body{margin:0;font-family:var(--font);color:var(--text);background:linear-gradient(180deg,#fff 0%,var(--bg) 100%);}
    .wrap{max-width:1200px;margin:34px auto;padding:0 18px 64px;}
    .title{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;line-height:1.6}
    .badge{border:1px solid var(--line);background:#f9fafb;color:#374151;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;white-space:nowrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .section-h{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .section-h h2{margin:0;font-size:15px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:260px;flex:1}
    label{font-size:12px;font-weight:900;color:#374151}
    input,select{width:100%;box-sizing:border-box;padding:11px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;background:#fff;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .btn{border:1px solid var(--line);background:#fff;color:#111827;padding:11px 14px;border-radius:12px;font-weight:900;cursor:pointer;white-space:nowrap}
    .btn.primary{border-color:transparent;background:var(--p);color:#fff}
    .btn.primary:hover{background:var(--p2)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .divider{height:1px;background:var(--line);margin:12px 0 14px}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);background:#f9fafb;padding:7px 10px;border-radius:999px;font-size:12px;color:#374151;white-space:nowrap}
    .pill b{color:var(--text)}
    .note{margin-top:12px;padding:12px 14px;border-radius:14px;background:#f9fafb;border:1px dashed var(--line);color:#374151;font-size:12px;line-height:1.7}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px 10px;text-align:left;font-size:12px;color:#374151;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line);padding:10px 10px;font-size:13px;white-space:nowrap}
    tbody tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .toast{position:fixed;right:18px;bottom:18px;width:min(460px,calc(100% - 36px));background:#111827;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 10px 25px rgba(17,24,39,.25);display:none;font-size:13px;line-height:1.5;z-index:30}
    .toast .sub{color:rgba(255,255,255,.75);font-size:12px;margin-top:4px}
    .pane-stack{display:flex;flex-direction:column;gap:14px}
    .hidden{display:none!important}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      table{display:block;overflow-x:auto}
      .field{min-width:100%}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div>
      <h1>ギフトコード管理｜式場別 有効化</h1>
      <div class="sub">
        式場から「コース別の販売数」と「有効化予定日（納品予定日）」の連絡を受けた後、未有効（DRAFT）在庫から<strong>先入れ先出し（古いロット優先）</strong>で自動選定して有効化します。<br/>
        取消は行わず、追加が発生した場合は別の発送番号として作成します。
      </div>
    </div>
    <div class="badge">業務設計確認用モック</div>
  </div>

  <div class="pane-stack">
    <!-- 上：入力 -->
    <div class="card">
      <div class="section-h">
        <h2>式場からの販売連絡</h2>
        <span class="badge">式場＋納品予定日＋4コース枚数</span>
      </div>

      <div class="row">
        <div class="field">
          <label for="Venue">式場</label>
          <select id="Venue">
            <option>○○ブライダル（本店）</option>
            <option>△△ホテル（婚礼）</option>
            <option>□□ゲストハウス</option>
          </select>
        </div>
        <div class="field">
          <label for="Planned">有効化予定日（納品予定日）</label>
          <input id="Planned" type="date" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid">
        <div class="field">
          <label for="QtyA">コースA 販売数</label>
          <input id="QtyA" value="2" inputmode="numeric" />
        </div>
        <div class="field">
          <label for="QtyB">コースB 販売数</label>
          <input id="QtyB" value="1" inputmode="numeric" />
        </div>
        <div class="field">
          <label for="QtyC">コースC 販売数</label>
          <input id="QtyC" value="0" inputmode="numeric" />
        </div>
        <div class="field">
          <label for="QtyD">コースD 販売数</label>
          <input id="QtyD" value="0" inputmode="numeric" />
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn primary" type="button" onclick="activateByVenue()">有効化して発送リストを作成</button>
        <button class="btn" id="dlBtnTop" type="button" onclick="downloadCsv()" disabled>データダウンロード（CSV）</button>
      </div>

      <div class="note">
        <b>CSV（同梱書類への編集を想定）</b><br/>
        先頭行に「式場」「発送番号」「有効化予定日」を付加し、その下に明細（繰り返し行）を出力します。
      </div>
    </div>

    <!-- 下：結果（ボタン押下後に表示） -->
    <div class="card hidden" id="lowerPane">
      <div class="section-h">
        <h2>今回 有効化したギフトコード一覧（発送リスト）</h2>
        <span class="badge">自動選定結果</span>
      </div>

      <div class="pillbar">
        <div class="pill">式場：<b id="sumVenue">—</b></div>
        <div class="pill">発送番号：<b id="sumShipNo">—</b></div>
        <div class="pill">有効化予定日：<b id="sumPlanned">—</b></div>
        <div class="pill">件数：<b id="sumCount">—</b></div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn" id="dlBtnBottom" type="button" onclick="downloadCsv()" disabled>データダウンロード（CSV）</button>
      </div>

      <div style="height:10px"></div>

      <table aria-label="発送リスト">
        <thead>
          <tr>
            <th>コース名</th>
            <th>ロット番号</th>
            <th>シリアル番号</th>
            <th>有効化予定日</th>
            <th>ギフトコード（参考表示）</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ===== ユーティリティ =====
  const el = (id) => document.getElementById(id);

  // 簡易トースト（無ければalertに退避）
  function toast(msg, sub){
    const t = el("toast");
    if(!t){ alert(sub ? `${msg}\n${sub}` : msg); return; }
    t.innerHTML = `<b>${msg}</b>` + (sub ? `<div class="sub">${sub}</div>` : "");
    t.style.display = "block";
    clearTimeout(window.__tt);
    window.__tt = setTimeout(()=> t.style.display="none", 3200);
  }

  function toInt(v){
    const n = Number(v);
    return (Number.isFinite(n) && n >= 0) ? Math.floor(n) : NaN;
  }

  // ===== ギフトコード生成（XXXX-XXXX-XXXX / 32種）=====
  const ALPHABET = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  function randChunk(n){
    let s="";
    for(let i=0;i<n;i++){
      s += ALPHABET[Math.floor(Math.random() * ALPHABET.length)];
    }
    return s;
  }
  function genCode12(){
    return `${randChunk(4)}-${randChunk(4)}-${randChunk(4)}`;
  }

  // ===== コース名（表示用）=====
  const COURSES = {
    A:"コースA（例：11,800円）",
    B:"コースB（例：5,800円）",
    C:"コースC（例：3,800円）",
    D:"コースD（例：2,800円）",
  };

  // ===== モック用：DRAFT在庫（複数ロット）=====
  function makeStock(lotNo, courseKey, n){
    const arr=[];
    for(let i=1;i<=n;i++){
      const serial4=String(i).padStart(4,"0");
      arr.push({
        status:"DRAFT",
        courseKey,
        courseName:COURSES[courseKey],
        lot_no:lotNo,
        serial_no:`${lotNo}-${serial4}`,
        code:genCode12(),
      });
    }
    return arr;
  }

  const draftStock = [
    ...makeStock("202601-02","A",8),
    ...makeStock("202601-02","B",8),
    ...makeStock("202601-02","C",8),
    ...makeStock("202601-02","D",8),
    ...makeStock("202602-01","A",10),
    ...makeStock("202602-01","B",10),
    ...makeStock("202602-01","C",10),
    ...makeStock("202602-01","D",10),
  ];

  // ===== 発送番号採番：VS-YYYYMMDD-###（日次連番）=====
  const shipCounterByDay = {};
  function nextShipmentNo(dateStr){
    const key = (dateStr || "").replaceAll("-","");
    shipCounterByDay[key] = (shipCounterByDay[key] || 0) + 1;
    const seq = String(shipCounterByDay[key]).padStart(3,"0");
    return `VS-${key}-${seq}`;
  }

  // ===== FIFO：lot_no asc → serial_no asc で先頭から取る =====
  function pickDraftFIFO(courseKey, qty){
    const picked=[];
    const candidates = draftStock
      .filter(x => x.status==="DRAFT" && x.courseKey===courseKey)
      .sort((a,b)=>`${a.lot_no}|${a.serial_no}`.localeCompare(`${b.lot_no}|${b.serial_no}`));

    for(const item of candidates){
      if(picked.length >= qty) break;
      item.status = "ACTIVE";
      picked.push(item);
    }
    return picked;
  }

  // ===== 状態（今回作成した発送リスト）=====
  let lastActivated = [];
  let lastShipmentNo = "";
  let lastVenueName = "";
  let lastPlanned = "";

  // ★ これがボタンに紐づく本体：下ペインに一覧を表示する
  function activateByVenue(){
    const venue = el("Venue")?.value;
    const planned = el("Planned")?.value;

    if(!venue){ toast("式場を選択してください"); return; }
    if(!planned){ toast("有効化予定日（納品予定日）を入力してください"); return; }

    const qa=toInt(el("QtyA")?.value), qb=toInt(el("QtyB")?.value), qc=toInt(el("QtyC")?.value), qd=toInt(el("QtyD")?.value);
    if([qa,qb,qc,qd].some(x=>Number.isNaN(x))){ toast("販売数を正しく入力してください（0以上の整数）"); return; }
    if(qa+qb+qc+qd===0){ toast("販売数がすべて0です"); return; }

    // 在庫チェック（モック）
    const need={A:qa,B:qb,C:qc,D:qd};
    for(const k of ["A","B","C","D"]){
      const available = draftStock.filter(x=>x.status==="DRAFT" && x.courseKey===k).length;
      if(need[k] > available){
        toast("在庫が不足しています（モック）", `${COURSES[k]}：必要 ${need[k]} / 在庫 ${available}`);
        return;
      }
    }

    // 発送番号
    const shipNo = nextShipmentNo(planned);

    // 自動選定 → ACTIVE化
    lastActivated = [
      ...pickDraftFIFO("A", qa),
      ...pickDraftFIFO("B", qb),
      ...pickDraftFIFO("C", qc),
      ...pickDraftFIFO("D", qd),
    ].map(x=>({
      ...x,
      planned_activation_date: planned,
      venue_name: venue,
      shipment_no: shipNo,
    }));

    lastShipmentNo = shipNo;
    lastVenueName = venue;
    lastPlanned = planned;

    // 下ペインのサマリー更新（要素が無ければスキップ）
    if(el("sumVenue")) el("sumVenue").textContent = venue;
    if(el("sumShipNo")) el("sumShipNo").textContent = shipNo;
    if(el("sumPlanned")) el("sumPlanned").textContent = planned.replaceAll("-","/");
    if(el("sumCount")) el("sumCount").textContent = String(lastActivated.length);

    // 下ペインの一覧描画
    const body = el("body");
    if(!body){
      toast("表示領域（tbody#body）が見つかりません", "HTML側に <tbody id=\"body\"></tbody> が必要です。");
      return;
    }
    body.innerHTML = "";
    lastActivated.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.courseName}</td>
        <td>${r.lot_no}</td>
        <td class="mono">${r.serial_no}</td>
        <td>${r.planned_activation_date.replaceAll("-","/")}</td>
        <td class="mono">${r.code}</td>
      `;
      body.appendChild(tr);
    });

    // 下ペインを表示
    const lowerPane = el("lowerPane");
    if(lowerPane){
      lowerPane.classList.remove("hidden");
      lowerPane.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // CSVボタン活性（存在する場合のみ）
    if(el("dlBtnTop")) el("dlBtnTop").disabled = false;
    if(el("dlBtnBottom")) el("dlBtnBottom").disabled = false;

    toast("発送リストを作成しました（モック）", `発送番号：${shipNo} / 件数：${lastActivated.length}`);
  }

  // CSV出力（必要なら）
  function downloadCsv(){
    if(!lastActivated.length){ toast("ダウンロード対象がありません"); return; }

    const pre = [
      ["式場", lastVenueName],
      ["発送番号", lastShipmentNo],
      ["有効化予定日（納品予定日）", lastPlanned],
      [],
    ];
    const headers=["コース名","ロット番号","シリアル番号","有効化予定日"];
    const rows = lastActivated.map(r=>[r.courseName,r.lot_no,r.serial_no,r.planned_activation_date]);

    const esc=(v)=>{const s=String(v??""); return /[,"\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;};
    const lines=[];
    pre.forEach(r=>{ if(r.length===0) lines.push(""); else lines.push(r.map(esc).join(",")); });
    lines.push(headers.map(esc).join(","));
    rows.forEach(r=>lines.push(r.map(esc).join(",")));

    const csv = lines.join("\r\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`shipment_${lastShipmentNo}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    toast("CSVをダウンロードしました（モック）", `発送番号：${lastShipmentNo}`);
  }

  // 初期値：日付=今日（存在する場合のみ）
  (function init(){
    const p = el("Planned");
    if(!p) return;
    const now=new Date();
    p.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
  })();
</script>

</body>
</html>
