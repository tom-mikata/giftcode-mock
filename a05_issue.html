<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ギフトコード管理｜発行</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--p:#2563eb;--p2:#1d4ed8;--shadow:0 10px 25px rgba(17,24,39,.08);--r:16px;
      --font:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",Arial,sans-serif;}
    body{margin:0;font-family:var(--font);color:var(--text);background:linear-gradient(180deg,#fff 0%,var(--bg) 100%);}
    .wrap{max-width:1080px;margin:34px auto;padding:0 18px 64px;}
    .title{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;line-height:1.5}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .section-h{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .section-h h2{margin:0;font-size:15px}
    .badge{border:1px solid var(--line);background:#f9fafb;color:#374151;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;white-space:nowrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px;min-width:240px;flex:1}
    label{font-size:12px;font-weight:900;color:#374151}
    input,select,textarea{width:100%;box-sizing:border-box;padding:11px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;background:#fff;outline:none}
    textarea{min-height:72px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .btn{border:1px solid var(--line);background:#fff;color:#111827;padding:11px 14px;border-radius:12px;font-weight:900;cursor:pointer;white-space:nowrap}
    .btn.primary{border-color:transparent;background:var(--p);color:#fff}
    .btn.primary:hover{background:var(--p2)}
    .divider{height:1px;background:var(--line);margin:12px 0 14px}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);background:#f9fafb;padding:7px 10px;border-radius:999px;font-size:12px;color:#374151;white-space:nowrap}
    .pill b{color:var(--text)}
    .note{margin-top:12px;padding:12px 14px;border-radius:14px;background:#f9fafb;border:1px dashed var(--line);color:#374151;font-size:12px;line-height:1.7}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px 10px;text-align:left;font-size:12px;color:#374151;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line);padding:10px 10px;font-size:13px;white-space:nowrap}
    tbody tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .toast{position:fixed;right:18px;bottom:18px;width:min(440px,calc(100% - 36px));background:#111827;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 10px 25px rgba(17,24,39,.25);display:none;font-size:13px;line-height:1.5;z-index:30}
    .toast .sub{color:rgba(255,255,255,.75);font-size:12px;margin-top:4px}
    @media (max-width: 860px){table{display:block;overflow-x:auto}.field{min-width:100%}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div>
      <h1>ギフトコード管理｜発行</h1>
      <div class="sub">新しいギフトカードを発行し、ロット番号とギフトコード一覧を確定します。</div>
    </div>
    <div class="badge">業務画面モック</div>
  </div>

  <div class="card">
    <div class="section-h">
      <h2>ロット</h2>
      <span class="badge">ロット起点</span>
    </div>

    <div class="row">
      <div class="controls" style="flex:1;">
        <div class="field">
          <label for="LotSelect">ロット番号</label>
          <select id="LotSelect">
            <option value="202604-01">202604-01（税込 11,800円コース / 12枚）</option>
            <option value="202603-02">202603-02（税込 5,800円コース / 6枚）</option>
          </select>
        </div>
        <button class="btn primary" type="button" onclick="loadLot()">ロットを表示</button>
      </div>
      <div class="controls">
        <a class="btn" href="a05_print.html">印刷用CSV</a>
        <a class="btn" href="a05_activate.html">販売済み有効化</a>
        <a class="btn" href="a05_inquiry.html">問い合わせ</a>
      </div>
    </div>

    <div class="divider"></div>

    <div class="pillbar">
      <div class="pill">ロット：<b id="sumLot">—</b></div>
      <div class="pill">コース：<b id="sumCourse">—</b></div>
      <div class="pill">発行数：<b id="sumIssued">—</b></div>
    </div>

    <div class="divider"></div>

    <div class="section-h">
      <h2>発行</h2>
      <span class="badge">単発／一括</span>
    </div>

    <div class="row">
      <div class="field">
        <label for="Course">コース</label>
        <select id="Course">
          <option>税込 11,800円コース</option>
          <option>税込 5,800円コース</option>
          <option>税込 3,800円コース</option>
        </select>
      </div>

      <div class="field">
        <label for="Qty">発行数（※単発発行は 1 固定）</label>
        <input id="Qty" value="50" inputmode="numeric" />
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="field">
      <label for="Memo">印刷メモ（任意）</label>
      <textarea id="Memo" placeholder="例）4月販促用。台紙A。"></textarea>
    </div>

    <div class="row" style="justify-content:flex-end; margin-top:10px;">
      <button class="btn" type="button" onclick="issueSingle()">単発発行（1枚）</button>
      <button class="btn primary" type="button" onclick="issueBulk()">一括発行</button>
    </div>

    <div class="note">
      発行すると「ロット番号」が確定し、ギフトカード印刷会社に渡すための印刷用CSVが出力できます（別画面）。
    </div>

    <div class="divider"></div>

    <div class="section-h">
      <h2>このロットのギフトコード一覧（例）</h2>
      <span class="badge">参照用</span>
    </div>

    <table aria-label="ギフトコード一覧">
      <thead>
        <tr>
          <th style="width:180px;">シリアル番号</th>
          <th>ギフトコード</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // モック用（表示と擬似発行）
  const ALPHABET="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  const lots={
    "202604-01":{lot_no:"202604-01",course:"税込 11,800円コース",items:[
      {serial_no:"202604-01-0001",code:"7KQZ-HM3R-X9TP-B4WC"},
      {serial_no:"202604-01-0002",code:"N8YD-R2KF-Q7LM-3VZP"},
      {serial_no:"202604-01-0003",code:"T6WB-XR9H-K4QP-8ZMF"},
    ]},
    "202603-02":{lot_no:"202603-02",course:"税込 5,800円コース",items:[
      {serial_no:"202603-02-0001",code:"K4QP-8ZMF-7KQZ-HM3R"},
      {serial_no:"202603-02-0002",code:"Z3VP-7K2R-W8ND-H5D9"},
    ]}
  };
  let currentLot="202604-01";
  const el=(id)=>document.getElementById(id);

  function toast(msg,sub){
    const t=el("toast");
    t.innerHTML=`<b>${msg}</b>`+(sub?`<div class="sub">${sub}</div>`:"");
    t.style.display="block";
    clearTimeout(window.__tt);
    window.__tt=setTimeout(()=>t.style.display="none",3200);
  }

  function randChunk(n){
    let s=""; for(let i=0;i<n;i++) s+=ALPHABET[Math.floor(Math.random()*ALPHABET.length)];
    return s;
  }
  function genCode(){ return `${randChunk(4)}-${randChunk(4)}-${randChunk(4)}-${randChunk(4)}`; }

  function nextLotNo(){
    const now=new Date();
    const y=now.getFullYear();
    const m=String(now.getMonth()+1).padStart(2,"0");
    const prefix=`${y}${m}`;
    const exists=Object.keys(lots).filter(k=>k.startsWith(prefix+"-"));
    const next=String(exists.length+1).padStart(2,"0");
    return `${prefix}-${next}`;
  }
  function nextSerial4(lotNo){
    const items=lots[lotNo].items;
    const max=Math.max(0,...items.map(i=>Number(i.serial_no.split("-").slice(-1)[0])));
    return String(max+1).padStart(4,"0");
  }

  function render(){
    const lot=lots[currentLot];
    el("sumLot").textContent=lot.lot_no;
    el("sumCourse").textContent=lot.course;
    el("sumIssued").textContent=String(lot.items.length);

    const body=el("listBody");
    body.innerHTML="";
    lot.items.slice().sort((a,b)=>a.serial_no.localeCompare(b.serial_no)).forEach(i=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td class="mono">${i.serial_no}</td><td class="mono">${i.code}</td>`;
      body.appendChild(tr);
    });
  }

  function loadLot(){
    currentLot=el("LotSelect").value;
    render();
    toast("ロットを表示しました",`ロット番号：${currentLot}`);
  }

  function issueSingle(){
    const course=el("Course").value;
    const lotNo=nextLotNo();
    lots[lotNo]={lot_no:lotNo,course,items:[]};

    const code=genCode();
    const serial4=nextSerial4(lotNo);
    lots[lotNo].items.push({serial_no:`${lotNo}-${serial4}`,code});

    // セレクトに追加
    const opt=document.createElement("option");
    opt.value=lotNo;
    opt.textContent=`${lotNo}（${course} / 1枚）`;
    el("LotSelect").appendChild(opt);
    el("LotSelect").value=lotNo;
    currentLot=lotNo;

    render();
    toast("単発発行しました（モック）",`ロット番号：${lotNo} / 1枚`);
  }

  function issueBulk(){
    const course=el("Course").value;
    const qty=Number(el("Qty").value);
    if(!Number.isFinite(qty) || qty<=0){ toast("発行数を正しく入力してください"); return; }

    const lotNo=nextLotNo();
    lots[lotNo]={lot_no:lotNo,course,items:[]};

    for(let i=0;i<qty;i++){
      const code=genCode();
      const serial4=nextSerial4(lotNo);
      lots[lotNo].items.push({serial_no:`${lotNo}-${serial4}`,code});
    }

    const opt=document.createElement("option");
    opt.value=lotNo;
    opt.textContent=`${lotNo}（${course} / ${qty}枚）`;
    el("LotSelect").appendChild(opt);
    el("LotSelect").value=lotNo;
    currentLot=lotNo;

    render();
    toast("一括発行しました（モック）",`ロット番号：${lotNo} / ${qty}枚`);
  }

  render();
</script>
</body>
</html>
