<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ギフトコード管理｜式場出荷（一覧／履歴）</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--p:#2563eb;--p2:#1d4ed8;--shadow:0 10px 25px rgba(17,24,39,.08);--r:16px;
      --font:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",Arial,sans-serif;}
    body{margin:0;font-family:var(--font);color:var(--text);background:linear-gradient(180deg,#fff 0%,var(--bg) 100%);}
    .wrap{max-width:1200px;margin:34px auto;padding:0 18px 64px;}
    .title{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;line-height:1.6}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .section-h{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .section-h h2{margin:0;font-size:15px}
    .badge{border:1px solid var(--line);background:#f9fafb;color:#374151;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;white-space:nowrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between}
    .field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    label{font-size:12px;font-weight:900;color:#374151}
    input,select{width:100%;box-sizing:border-box;padding:11px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;background:#fff;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .btn{border:1px solid var(--line);background:#fff;color:#111827;padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer;white-space:nowrap}
    .btn.primary{border-color:transparent;background:var(--p);color:#fff}
    .btn.primary:hover{background:var(--p2)}
    .divider{height:1px;background:var(--line);margin:12px 0 14px}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px 10px;text-align:left;font-size:12px;color:#374151;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line);padding:10px 10px;font-size:13px;white-space:nowrap;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;border:1px solid var(--line);background:#f9fafb;padding:5px 8px;border-radius:999px;font-size:12px;color:#374151;margin-right:6px}
    .count b{color:var(--text)}
    .toast{position:fixed;right:18px;bottom:18px;width:min(460px,calc(100% - 36px));background:#111827;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 10px 25px rgba(17,24,39,.25);display:none;font-size:13px;line-height:1.5;z-index:30}
    .toast .sub{color:rgba(255,255,255,.75);font-size:12px;margin-top:4px}
    /* modal */
    .modal-bg{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:40}
    .modal{width:min(980px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 20px 50px rgba(0,0,0,.25);overflow:hidden}
    .modal-h{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#f9fafb;border-bottom:1px solid var(--line);gap:10px;flex-wrap:wrap}
    .modal-h b{font-size:14px}
    .modal-b{padding:14px 16px}
    @media (max-width: 980px){table{display:block;overflow-x:auto}.field{min-width:100%}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div>
      <h1>ギフトコード管理｜式場出荷（一覧／履歴）</h1>
      <div class="sub">
        式場への出荷単位（出荷番号）で、いつ・どの式場へ・何枚を有効化し、どのギフトコードを渡したかを確認します。<br/>
        取消は行わず、追加が発生した場合は別の出荷番号として記録されます。
      </div>
    </div>
    <div class="badge">業務設計確認用モック</div>
  </div>

  <div class="card">
    <div class="section-h">
      <h2>検索</h2>
      <span class="badge">式場 / 納品予定日</span>
    </div>

    <div class="row">
      <div class="field">
        <label for="fVenue">式場</label>
        <select id="fVenue">
          <option value="">（すべて）</option>
          <option>○○ブライダル（本店）</option>
          <option>△△ホテル（婚礼）</option>
          <option>□□ゲストハウス</option>
        </select>
      </div>
      <div class="field">
        <label for="fFrom">納品予定日（開始）</label>
        <input id="fFrom" type="date" />
      </div>
      <div class="field">
        <label for="fTo">納品予定日（終了）</label>
        <input id="fTo" type="date" />
      </div>
      <button class="btn primary" type="button" onclick="applyFilter()">検索</button>
    </div>

    <div class="divider"></div>

    <div class="section-h">
      <h2>出荷一覧</h2>
      <span class="badge">1行＝1出荷番号</span>
    </div>

    <table aria-label="式場出荷一覧">
      <thead>
        <tr>
          <th>出荷番号</th>
          <th>式場</th>
          <th>納品予定日</th>
          <th>枚数（コース別）</th>
          <th>作成日時</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="divider"></div>

    <div class="muted" style="font-size:12px;line-height:1.7">
      ※「CSV再ダウンロード」は、同梱書類として編集する前提の体裁（先頭行に式場/出荷番号/納品予定日）で出力されます。
    </div>
  </div>
</div>

<!-- modal -->
<div class="modal-bg" id="mbg" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-h">
      <div>
        <b id="mTitle">出荷詳細</b>
        <div class="muted" style="font-size:12px;margin-top:4px" id="mSub">—</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="downloadShipmentCsv(activeShipmentId)">CSV再ダウンロード</button>
        <button class="btn" onclick="hideModal()">閉じる</button>
      </div>
    </div>
    <div class="modal-b">
      <table aria-label="出荷明細（ギフトコード一覧）">
        <thead>
          <tr>
            <th>コース名</th>
            <th>ロット番号</th>
            <th>シリアル番号</th>
            <th>納品予定日</th>
            <th>ギフトコード（参考）</th>
          </tr>
        </thead>
        <tbody id="mBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const el=(id)=>document.getElementById(id);
  function toast(msg,sub){
    const t=el("toast");
    t.innerHTML=`<b>${msg}</b>`+(sub?`<div class="sub">${sub}</div>`:"");
    t.style.display="block";
    clearTimeout(window.__tt);
    window.__tt=setTimeout(()=>t.style.display="none",3200);
  }

  // ===== サンプル（履歴データ）=====
  const SHIPMENTS = [
    mkShipment("VS-20260220-001","○○ブライダル（本店）","2026-02-20",{A:2,B:1,C:0,D:0},"2026-02-16 10:12"),
    mkShipment("VS-20260220-002","○○ブライダル（本店）","2026-02-20",{A:0,B:0,C:3,D:0},"2026-02-17 09:03"), // 追加
    mkShipment("VS-20260228-001","△△ホテル（婚礼）","2026-02-28",{A:1,B:0,C:0,D:2},"2026-02-18 16:44"),
    mkShipment("VS-20260305-001","□□ゲストハウス","2026-03-05",{A:0,B:2,C:0,D:1},"2026-02-19 11:20"),
  ];

  const COURSES = {
    A:"コースA（例：11,800円）",
    B:"コースB（例：5,800円）",
    C:"コースC（例：3,800円）",
    D:"コースD（例：2,800円）",
  };

  const ALPHABET="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  function randChunk(n){
    let s=""; for(let i=0;i<n;i++) s+=ALPHABET[Math.floor(Math.random()*ALPHABET.length)];
    return s;
  }
  function genCode12(){ return `${randChunk(4)}-${randChunk(4)}-${randChunk(4)}`; }

  function mkShipment(id, venue, planned, qty, created_at){
    // 明細もサンプル生成（FIFOなどの厳密性はここでは省略）
    const details=[];
    const lots=["202601-02","202602-01"];
    let serialSeq=1;
    for(const k of ["A","B","C","D"]){
      for(let i=0;i<(qty[k]||0);i++){
        const lot = lots[(serialSeq+i)%lots.length];
        const serial = `${lot}-${String(serialSeq).padStart(4,"0")}`;
        serialSeq++;
        details.push({
          courseName: COURSES[k],
          lot_no: lot,
          serial_no: serial,
          planned,
          code: genCode12(),
        });
      }
    }
    return { id, shipment_no:id, venue_name:venue, planned_activation_date:planned, qty, created_at, details };
  }

  function within(dateStr, fromStr, toStr){
    if(!dateStr) return false;
    if(fromStr && dateStr < fromStr) return false;
    if(toStr && dateStr > toStr) return false;
    return true;
  }

  function render(list){
    const tb=el("tbody");
    tb.innerHTML="";
    list.forEach(s=>{
      const qty = s.qty || {};
      const pills = [
        `<span class="pill count">A <b>${qty.A||0}</b></span>`,
        `<span class="pill count">B <b>${qty.B||0}</b></span>`,
        `<span class="pill count">C <b>${qty.C||0}</b></span>`,
        `<span class="pill count">D <b>${qty.D||0}</b></span>`,
      ].join("");

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="mono">${s.shipment_no}</td>
        <td>${s.venue_name}</td>
        <td>${s.planned_activation_date.replaceAll("-","/")}</td>
        <td>${pills}</td>
        <td class="mono">${s.created_at}</td>
        <td>
          <button class="btn" onclick="openDetail('${s.id}')">明細</button>
          <button class="btn" onclick="downloadShipmentCsv('${s.id}')">CSV再DL</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function applyFilter(){
    const v=el("fVenue").value;
    const from=el("fFrom").value;
    const to=el("fTo").value;

    const list = SHIPMENTS.filter(s=>{
      if(v && s.venue_name!==v) return false;
      if(!within(s.planned_activation_date, from, to)) return false;
      return true;
    });

    render(list);
    toast("検索結果を表示しました", `件数：${list.length}`);
  }

  // ===== CSV（先頭行に式場/出荷番号/納品予定日）=====
  function downloadShipmentCsv(id){
    const s = SHIPMENTS.find(x=>x.id===id);
    if(!s){ toast("対象が見つかりません"); return; }

    const pre = [
      ["式場", s.venue_name],
      ["出荷番号", s.shipment_no],
      ["有効化予定日（納品予定日）", s.planned_activation_date],
      [],
    ];
    const headers=["コース名","ロット番号","シリアル番号","有効化予定日"];
    const rows = (s.details||[]).map(d=>[d.courseName,d.lot_no,d.serial_no,d.planned]);

    const esc=(v)=>{const str=String(v??""); return /[,"\n]/.test(str)?`"${str.replace(/"/g,'""')}"`:str;};
    const lines=[];
    pre.forEach(r=>{ if(r.length===0) lines.push(""); else lines.push(r.map(esc).join(",")); });
    lines.push(headers.map(esc).join(","));
    rows.forEach(r=>lines.push(r.map(esc).join(",")));

    const csv = lines.join("\r\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`shipment_${s.shipment_no}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    toast("CSVをダウンロードしました（モック）", `出荷番号：${s.shipment_no}`);
  }

  // ===== 詳細モーダル =====
  let activeShipmentId = "";
  function openDetail(id){
    const s = SHIPMENTS.find(x=>x.id===id);
    if(!s){ toast("対象が見つかりません"); return; }

    activeShipmentId = id;
    el("mTitle").textContent = `出荷詳細：${s.shipment_no}`;
    el("mSub").textContent = `式場：${s.venue_name} / 納品予定日：${s.planned_activation_date.replaceAll("-","/")} / 明細：${(s.details||[]).length}件`;

    const mb=el("mBody");
    mb.innerHTML="";
    (s.details||[]).forEach(d=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${d.courseName}</td>
        <td>${d.lot_no}</td>
        <td class="mono">${d.serial_no}</td>
        <td>${d.planned.replaceAll("-","/")}</td>
        <td class="mono">${d.code}</td>
      `;
      mb.appendChild(tr);
    });

    el("mbg").style.display="flex";
  }
  function hideModal(){ el("mbg").style.display="none"; }
  function closeModal(e){ hideModal(); }

  // 初期表示：直近30日っぽい範囲を入れて一覧表示
  (function init(){
    const today=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const y=today.getFullYear(), m=today.getMonth()+1, d=today.getDate();
    el("fFrom").value = `${y}-${pad(m)}-${pad(Math.max(1,d-30))}`;
    el("fTo").value = `${y}-${pad(m)}-${pad(d)}`;
    render(SHIPMENTS);
  })();
</script>
</body>
</html>
